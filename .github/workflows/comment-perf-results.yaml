name: Comment Performance Results
on:
  workflow_dispatch: # TODO: Remove after testing
    inputs:
      run_id:
        description: 'Workflow run ID to fetch artifacts from'
        required: true
  workflow_run:
    workflows: ["kind-perf-e2e"]
    types:
      - completed

jobs:
  comment:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      actions: read
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        continue-on-error: true
        with:
          pattern: performance-results-*
          path: ./artifacts
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse results and comment
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const artifactsDir = './artifacts';
            const runId = context.payload.workflow_run?.id || context.payload.inputs?.run_id;
            const conclusion = context.payload.workflow_run?.conclusion || 'unknown';
            const repoUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}`;
            const commentMarker = '<!-- perf-results-comment -->';
            
            let comment = `${commentMarker}\n## ðŸ“Š Performance Test Results\n\n`;
            comment += `**Status**: ${conclusion === 'success' ? 'âœ… Passed' : 'âŒ Failed'}\n\n`;
            
            const findJsonFiles = (dir) => {
              if (!fs.existsSync(dir)) return;
              const files = fs.readdirSync(dir, { withFileTypes: true });
              for (const file of files) {
                const fullPath = path.join(dir, file.name);
                if (file.isDirectory()) {
                  findJsonFiles(fullPath);
                } else if (file.name.endsWith('_performance_report.json')) {
                  const data = JSON.parse(fs.readFileSync(fullPath, 'utf8'));
                  comment += `### ${data.test_name} (${data.test_type})\n`;
                  comment += `| Metric | Value |\n|--------|-------|\n`;
                  comment += `| Duration | ${(data.total_time / 1e9).toFixed(2)}s |\n`;
                  comment += `| Pods | ${data.total_pods} (${data.change_in_pod_count >= 0 ? '+' : ''}${data.change_in_pod_count}) |\n`;
                  comment += `| Nodes | ${data.total_nodes} (${data.change_in_node_count >= 0 ? '+' : ''}${data.change_in_node_count}) |\n`;
                  comment += `| Karpenter Memory | ${data.karpenter_memory_mb > 0 ? data.karpenter_memory_mb.toFixed(2) + ' MB' : 'N/A'} |\n`;
                  comment += `| CPU Utilization | ${(data.total_reserved_cpu_utilization * 100).toFixed(2)}% |\n`;
                  comment += `| Memory Utilization | ${(data.total_reserved_memory_utilization * 100).toFixed(2)}% |\n`;
                  comment += `| Efficiency Score | ${data.resource_efficiency_score.toFixed(1)}% |\n\n`;
                }
              }
            };
            
            findJsonFiles(artifactsDir);
            
            comment += `ðŸ“¦ [Download artifacts (includes pprof memory profiles)](${repoUrl}/actions/runs/${runId})\n`;
            comment += `\n---\n*Run ID: ${runId}*`;
            
            const prNumber = context.payload.workflow_run.pull_requests[0]?.number;
            if (!prNumber) return;
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const existingComment = comments.find(c => 
              c.user.login === 'github-actions[bot]' && 
              c.body.includes(commentMarker)
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment,
              });
            }
